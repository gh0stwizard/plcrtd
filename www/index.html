<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The plcrtd project: OpenSSL Certificate Manager">
  <meta name="keywords" content="perl, knockout, openssl, ca, pkcs, generator, online">
  <meta name="author" content="gh0stwizard">
  <meta charset="utf-8">
  <title>plcrtd &part; OpenSSL Certificate Manager &forall;</title>
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <script type="text/javascript" src="/js/knockout-3.3.0.js"></script>
  <script type="text/javascript" src="/js/zepto.min.js"></script>
  <script type="text/javascript" src="/js/signals.min.js"></script>
  <script type="text/javascript" src="/js/crossroads.min.js"></script>
  <script type="text/javascript" src="/js/hasher.min.js"></script>
  <!-- script type="text/javascript" src="/js/Blob.js"></script //-->
<style type="text/css">
  html, body, button, p, input, select {
    font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
    font-size: 1.0em;
  }

  textarea {
    font-family: "Lucida Console", Monaco, monospace;
    font-size: 1.0em;
    border: 0;
  }
  
  table {
    width: 100%;
  }

  /*  http://css3buttongenerator.com  */

  .btn {
    color: #ffffff;
    font-size: 0.85em;
    background: #16167a;
    padding: 7px 20px 7px 20px;
    text-decoration: none;
    border: 0;
  }
  .btn:hover {
    background: #339955;
  }

  /* http://stackoverflow.com/questions/3759692/css-selector-for-disabled-input-type-submit */

  input[type=submit]:disabled.btn,
  button:disabled.btn {
    background: #993355;
  }

  /*  Error message  */

  .errorBox p {
    text-align: center;
    font-size: 1.4em;
    font-weight: bolder;
  }

  .content {
    left: 0;
    right: 0;
    width: 90%;
    margin: 0 auto;
    max-width: 1024px;
  }

  /*  Header  */

  .header button {
    margin-left: 18px;
  }
  .header img {
    height: 24px;
    width: 24px;
    float: right;
    vertical-align: middle;
  }

  /*  Pages  */

  .aboutPage,
  .caPage,
  .clientPage,
  .pkcsPage,
  .Page {
    padding-top: 22px;
  }

  /*  About  */

  .aboutPage {
    padding-left: 10px;
  }

  /* Text data container */

  .boxContainer {
    display: flex;
  }

  .boxOutput {
    border: 1px solid black;
  }
  
  .boxInput {
    display: table-cell;
    border: 1px solid #029;
  }

  .boxButtonsContainer {
    display: inline;
    padding-top: 16px;
    padding-left: 12px;
  }
  .boxButtonsContainer button {
    margin: 12px 0;
    width: 120px;
  }

  .boxSetup {
    padding-top: 5px;
    padding-bottom: 15px;
  }
  .boxSetup p {
    display: inline;
    padding-right: 12px;
    color: #039;
  }
  .boxSetup select {
    border: 1px solid #029;
  }
  .boxSetup input {
    border: 0;
    border-bottom: 1px solid #029;
  }
  .boxSetup input.file {
    border: 1px solid #029;
  }

  /*  Footer  */

  .footer {
    padding-top: 15px;
    padding-bottom: 15px;
  }


/* 
 * Table style from
 *   http://www.smashingmagazine.com/2008/08/13/top-10-css-table-designs/
 */

#Table {
  font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
  font-size: 1.0em;
  margin-top: 15px;
  text-align: left;
  border-collapse: collapse;
}
#Table th, #AppTable th {
  font-size: 1.2em;
  font-weight: normal;
  padding: 12px 15px;
  color: #039;
  text-align: left;
}
#Table td {
  padding: 10px 15px;
  color: #669;
  border-top: 1px solid #e8edff;
  cursor: default;
}
#Table tr:hover td {
  color: #339;
  background: #eff2ff;
}

/* prevent color changing for links */

#Table tr td a,
#Table tr td a:visited {
  color: blue;
}


/* table for application info */

#hTable {
  margin-top: 24px;
  border-collapse: collapse;
}
#hTable th {
  text-align: right;
  color: #039;
}
#hTable td {
  padding: 10px 15px;
  color: #669;
  border-bottom: 1px solid #e8edff;	
}
#hTable td.editable {
  padding: 0 15px;
}
#hTable td input {
  font-size: 1.2em;
  border: 0;
  border-bottom: 1px solid #aaaaff;
}
#hTable td.bless,
#hTable td.button {
  border: 0;
}
#hTable td.button {
  padding-top: 24px;
}
#hTable th.buttomline {
  border-bottom: 1px solid #e8edff;
}

  .embedView {
    padding-left: 24px;
  }


</style>
</head>
<body>
<div class="content">

  <!-- Header :: buttons & loading animation //-->
  <div class="header">
      <button class="btn" data-bind="click: About">About</button>
      <button class="btn" data-bind="click: Configure">Configure</button>
      <button class="btn" data-bind="click: CA">CA</button>
      <button class="btn" data-bind="click: Client">Client</button>
      <button class="btn" data-bind="click: PKCS">PKCS</button>
      <!-- http://spiffygif.com //-->
      <img src="/img/spiffygif.gif" alt="Loading"
           data-bind="visible: onAJAX()" />
  </div>

  <!-- Error message box //-->
  <div class="errorBox" data-bind="visible: errorMessage()">
    <p><span data-bind="text: errorMessage"></span></p>
    <pre><span data-bind="text: errorDescription"></span></pre>
  </div>

  <!-- About page //-->
  <div class="aboutPage" data-bind="visible: onAbout()">
    <h1>The plcrtd project: OpenSSL Certificate Manager</h1>
    <h2>Description</h2>
    <p>This is an online web certificate manager implemented
       as described in 
       <a title="Mini tutorial for configuring client-side SSL certificates."
          href="https://gist.github.com/mtigas/952344" >howto</a>
          written by 
       <a href="https://gist.github.com/mtigas"
          title="About user mtigas on GitHub">mtigas</a>.
    </p>
    <h2>Goals</h2>
    <ul>
      <li>Provide a service to managing OpenSSL certificates.</li>
      <li>An integration with the
        <a href="http://www.nginx.org" title="nginx website">nginx</a>
        project.</li>
      <li>An interface to send a client certificate via email.</li>
    </ul>
    <h2>Development</h2>
    <p>This is an open source project. Please, checkout sources
      <a href="https://github.com/gh0stwizard/plcrtd"
         title="plcrtd on GitHub">here</a>.</p>
  </div>
  
  <!-- Configuration Page //-->
  <div class="Page" data-bind="visible: onConfigure()">
    <h2>Databases</h2>
    <button class="btn" data-bind="click: tUpdateDB">Create DB</button>
    <button class="btn" data-bind="click: tWipeDBs">Wipe DBs</button>
    <div class="embedView" data-bind="visible: onUpdateDB()">
      <table id="hTable">
        <colgroup><col width="15%"></col></colgroup>
        <tbody>
          <tr>
            <th>Name</th>
            <td class="editable"><input data-bind="value: dbname" /></td>
          </tr>
          <tr>
            <th>Description</th>
            <td class="editable"><input data-bind="value: dbdesc" /></td>
          </tr>
          <tr>
            <td class="button">&nbsp;</td>
            <td class="button">
              <button class="btn" data-bind="click: UpdateDBbtn">Submit</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="embedView" data-bind="visible: onWipeDBs()">
      <h3>Attention!</h3>
      <p>By pressing submit button you are accept to wipe 
         all databases from the server.</p>
      <button class="btn" data-bind="click: WipeDBbtn">Submit</button>
    </div>
    <div class="embedView" data-bind="visible: onDBTable() == true && DBList().length > 0">
      <table id="Table">
        <colgroup><col width="15%"><col width="50%"><col><col><col><col></colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th colspan="3">&nbsp;</th>
          </tr>
        </thead>
        <tbody data-bind="foreach: DBList">
          <tr>
            <td data-bind="text: $data.name"></td>
            <td data-bind="text: $data.desc"></td>
            <td data-bind="text: $data.open"></td>
            <td><a href="#" data-bind="click: $root.openDB" title="Open">Open</a></td>
            <td><a href="#" data-bind="click: $root.editDB" title="Edit">Edit</a></td>
            <td><a href="#" data-bind="click: $root.removeDB" title="Remove">Remove</a></td>
          </tr>
        </tbody>
      </table>
    </div>
    <h2>Settings</h2>
  </div>

  <!-- Certificate Authority Page //-->
  <div class="caPage" data-bind="visible: onCA()">
    <h3>Certificate Authority key</h3>
    <div class="boxSetup">
      <p>Password
      <input size="32" data-bind="value: inCAPassword" /></p>
      <p>Bits
      <select data-bind="options: bitsOptions, value: inCABits"></select></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outCAkey"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn"
                data-bind="click: genCAkey, enable: genCAkeyReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'ca.key', outCAkey() ),
                     visible: outCAkey() && browserCheck()">Save</button>
      </div>
    </div>
    <h3>Certificate Authority certificate</h3>
    <p>Please, provide the same password above as you've used for key generation.</p>
    <div class="boxSetup">
      <p>Subject
      <input size="42" class="subj" data-bind="value: inCASubject" /></p>
      <p>Days
      <input size="4" data-bind="value: inCADays" /></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outCAcrt"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn" data-bind="click: genCAcrt, enable: genCAcrtReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'ca.crt', outCAcrt() ),
                     visible: outCAcrt() && browserCheck()">Save</button>
      </div>
    </div>
  </div>

  <!-- Client Page //-->
  <div class="clientPage" data-bind="visible: onClient()">
    <h3>Client Certificate key</h3>
    <div class="boxSetup">
      <p>Password
      <input size="32" data-bind="value: inClientPassword" /></p>
      <p>Bits
      <select data-bind="options: bitsOptions, value: inClientBits"></select></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outClientKey"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn"
                data-bind="click: genClientKey, enable: genClientKeyReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'client.key', outClientKey() ),
                     visible: outClientKey() && browserCheck()">Save</button>
      </div>
    </div>
    <h3>Client Certificate request</h3>
    <p>Please, provide the same password above as you've used for key generation.</p>
    <div class="boxSetup">
      <p>Subject
      <input size="42" class="subj" data-bind="value: inClientSubject" /></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outClientCsr"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn"
                data-bind="click: genClientCsr,
                          enable: genClientCsrReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'client.csr', outClientCsr() ),
                     visible: outClientCsr() && browserCheck()">Save</button>
      </div>
    </div>
    <h3>Client Certificate (self-signed)</h3>
    <div class="boxSetup">
      <p>CA key</p>
      <div class="boxInput">
        <textarea rows="10" cols="66" data-bind="value: inClientCAkey"></textarea>
      </div>
      <p>CA certificate</p>
      <div class="boxInput">
        <textarea rows="10" cols="66" data-bind="value: inClientCAcrt"></textarea>
      </div>
      <p>CA password
      <input size="32" data-bind="value: inClientCAPassword" /></p>
      <p>Days
      <input size="4" data-bind="value: inClientDays" /></p>
      <p>Serial
      <input size="4" data-bind="value: inClientSerial" /></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outClientCrt"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn"
                data-bind="click: genClientCrt,
                          enable: genClientCrtReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'client.crt', outClientCrt() ),
                     visible: outClientCrt() && browserCheck()">Save</button>
      </div>
    </div>    
  </div>

  <!-- PKCS Page //-->
  <div class="pkcsPage" data-bind="visible: onPKCS()">
    <h3>PKCS#12 file</h3>
    <div class="boxSetup">
      <p>Client certificate key</p>
      <div class="boxInput">
        <textarea rows="10" cols="66" data-bind="value: inPKCSClientKey"></textarea>
      </div>
      <p>Client certificate</p>
      <div class="boxInput">
        <textarea rows="10" cols="66" data-bind="value: inPKCSClientCrt"></textarea>
      </div>
      <p>Client password
      <input size="16" data-bind="value: inPKCSClientPwd" /></p>
      <p>Export password
      <input size="16" data-bind="value: inPKCSClientXpw" /></p>
    </div>
    <div class="boxContainer">
      <button class="btn" data-bind="click: genP12, enable: genP12Ready()">Get!</button>
    </div>
    <h3>Convert PKCS#12 to PEM</h3>
    <form action="/plcrtd" enctype="multipart/form-data" method="post">
    <div class="boxSetup">
      <p>PKCS#12 file
      <input type="file" class="file" name="p12" /></p>
      <br />
      <p>Password
      <input size="32" name="pwd" data-bind="value: inPKCSpemPwd" /></p>
    </div>
    <div class="boxContainer">
      <input type="hidden" name="action" value="convP12" />
      <input type="submit" class="btn" value="Get!" />
    </div>
    </form>
  </div>

  <div class="footer"></div>
  
  <iframe style="display: none" id="hframe"></iframe>

</div>
<script>
  var suffix = '/plcrtd',
      addr = window.location.protocol + '//' + window.location.host
      ra = addr + suffix + '?',
      errors = [
        'Connection error',
        'Bad request',
        'Not implemented',
        'Internal error'
      ],
      bitsOptions = [ 1024, 2048, 4096 ];


  function AppViewModel() {
    var self = this;

    /*  Data  */

    self.onAJAX = ko.observable();
    self.errorMessage = ko.observable();
    self.errorDescription = ko.observable();

    /*  Data: this app  */

    self.onAbout = ko.observable();
    self.onCA = ko.observable();
    self.onClient = ko.observable();
    self.onPKCS = ko.observable();


    self.onConfigure = ko.observable();
    self.onUpdateDB = ko.observable();
    self.onWipeDBs = ko.observable();

    self.dbname = ko.observable();
    self.dbdesc = ko.observable();
    self.dbopen = ko.observable();
    self.DBList = ko.observableArray( [ ] );
    self.onDBTable = ko.observable( false );
    
    self.isUpdate = ko.observable( false );
    
    self.tUpdateDB = function () {
      self.dbname( null );
      self.dbdesc( null );
    
      self.onWipeDBs( false );
      self.onDBTable( false );
      
      if ( self.onUpdateDB() ) {
        self.onUpdateDB( false );
        self.onDBTable( true );
        self.isUpdate( true );
      } else {
        self.onUpdateDB( true );
        self.onDBTable( false );
        self.isUpdate( false );
      }
      
      return false;
    }
    
    self.tWipeDBs = function () {
      self.onUpdateDB( false );
      self.onDBTable( false );

      if ( self.onWipeDBs() ) {
        self.onWipeDBs( false );
        self.onDBTable( true );
      } else {
        self.onWipeDBs( true );
      }
    }    

    self.inCAPassword = ko.observable();
    self.inCABits = ko.observable();
    self.inCADays = ko.observable();
    self.inCASubject = ko.observable();

    self.outCAkey = ko.observable();
    self.genCAkeyReady = ko.observable();

    self.outCAcrt = ko.observable();
    self.genCAcrtReady = ko.observable();


    self.inClientPassword = ko.observable();
    self.inClientBits = ko.observable();
    self.inClientDays = ko.observable();
    self.inClientSubject = ko.observable();
    self.inClientSerial = ko.observable();
    self.inClientCAPassword = ko.observable();
    self.inClientCAkey = ko.observable();
    self.inClientCAcrt = ko.observable();

    self.outClientKey = ko.observable();
    self.genClientKeyReady = ko.observable();

    self.outClientCsr = ko.observable();
    self.genClientCsrReady = ko.observable();

    self.outClientCrt = ko.observable();
    self.genClientCrtReady = ko.observable();

  
    self.genP12Ready = ko.observable();
    self.inPKCSClientCrt = ko.observable();
    self.inPKCSClientKey = ko.observable();
    self.inPKCSClientPwd = ko.observable();
    self.inPKCSClientXpw = ko.observable();
    
    self.outPKCSpem = ko.observable();
    self.convP12Ready = ko.observable();
    self.inPKCSpemPwd = ko.observable();
    
    self.inPKCSpemFile = ko.observable();


    self.browserCheck = ko.computed( function () {
      var version = parseFloat( navigator.appVersion );

      /* TODO mobile support ? */

      return ( navigator.userAgent.indexOf( "Firefox" ) != -1 
            && version > 20 )
          || ( navigator.userAgent.indexOf( "SeaMonkey" ) != -1 
            && version > 2.0 )
          || ( navigator.userAgent.indexOf( "Chrome" ) != -1
            && version > 14 )
          || ( navigator.userAgent.indexOf( "Firefox" ) != -1
            && version > 15 );
    } );


    /*  Behaviours  */

    self.About  = function () { location.hash = '';       }
    self.CA     = function () { location.hash = 'ca';     }
    self.Client = function () { location.hash = 'client'; }
    self.PKCS   = function () { location.hash = 'pkcs';   }
    
    self.Configure = function () { location.hash = 'configure'; }

    /*  http://caniuse.com/download  */

    self.save = function ( filename, text ) {
      var pom = document.createElement( 'a' );
      pom.setAttribute( 'href',
        'data:text/plain;charset=utf-8,' + encodeURIComponent(text) );
      pom.setAttribute( 'download', filename );

      if ( document.createEvent ) {
        var event = document.createEvent( 'MouseEvents' );
        event.initEvent( 'click', true, true );
        pom.dispatchEvent( event );
      } else {
        pom.click();
      }
    }

    self.genCAkey = function ( cb ) {
      self.outCAkey( null );
      self.outCAcrt( null );
      clearError();
      self.genCAkeyReady( false );

      var pass = self.inCAPassword(),
          bits = self.inCABits();

      postJSON( addr + suffix,
        {
          action: 'genCAkey',
          pass: pass,
          bits: bits
        },
        function ( response ) {
          if ( response.key ) {
            self.outCAkey( response.key );
            $.isFunction( cb ) ? cb() : "";
          } else {
            self.errorMessage( errors[ response.err ] );
            self.errorDescription( response.msg );
          }
          
          self.genCAkeyReady( true );
        }
      );
    }

    self.genCAcrt = function () {
      self.outCAcrt( null );
      clearError();
      self.genCAcrtReady( false );

      var cb = function () {
        var pass = self.inCAPassword(),
            days = self.inCADays(),
            subj = self.inCASubject(),
            key = self.outCAkey();

        postJSON( addr + suffix,
          {
            action: 'genCAcrt',
            pass: pass,
            key: key,
            days: days,
            subj: subj
          },
          function ( response ) {
            if ( response.crt ) {
              self.outCAcrt( response.crt );
            } else {
              self.errorMessage( errors[ response.err ] );
              self.errorDescription( response.msg );
            }
            
            self.genCAcrtReady( true );
          }
        );
      }

      if ( ! self.outCAkey() ) {
        self.genCAkey( cb );
      } else {
        cb();
      }
    }


    self.genClientKey = function ( cb ) {
      self.outClientKey( null );
      self.outClientCsr( null );
      self.outClientCrt( null );
      clearError();
      self.genClientKeyReady( false );

      var pass = self.inClientPassword(),
          bits = self.inClientBits();

      postJSON( addr + suffix,
        { 
          action: 'genClientKey',
          pass: pass,
          bits: bits
        },
        function ( response ) {
          if ( response.key ) {
            self.outClientKey( response.key );
            $.isFunction( cb ) ? cb() : "";
          } else {
            self.errorMessage( errors[ response.err ] );
            self.errorDescription( response.msg );
          }

          self.genClientKeyReady( true );
        }
      );
    }

    self.genClientCsr = function ( cb ) {
      self.outClientCsr( null );
      clearError();
      self.genClientCsrReady( false );

      var mycb = function () {
        var pass = self.inClientPassword(),
            subj = self.inClientSubject(),
            key = self.outClientKey();

        postJSON( addr + suffix,
          {
            action: 'genClientCsr',
            pass: pass,
            key: key,
            subj: subj
          },
          function ( response ) {
            if ( response.csr ) {
              self.outClientCsr( response.csr );
              $.isFunction( cb ) ? cb() : "";
            } else {
              self.errorMessage( errors[ response.err ] );
              self.errorDescription( response.msg );
            }
            
            self.genClientCsrReady( true );
          }
        );
      }

      if ( ! self.outClientKey() ) {
        self.genClientKey( mycb );
      } else {
        mycb();
      }
    }
    
    self.genClientCrt = function () {
      self.outClientCrt( null );
      clearError();
      self.genClientCrtReady( false );

      var mycb = function () {
        var csr = self.outClientCsr(),
            days = self.inClientDays(),
            cacrt = self.inClientCAcrt(),
            cakey = self.inClientCAkey(),
            capass = self.inClientCAPassword(),
            serial = self.inClientSerial();

        postJSON( addr + suffix,
          {
            action: 'genClientCrt',
            serial: serial,
            csr: csr,
            cacrt: cacrt,
            cakey: cakey,
            capass: capass,
            days: days
          },
          function ( response ) {
            if ( response.crt ) {
              self.outClientCrt( response.crt );
            } else {
              self.errorMessage( errors[ response.err ] );
              self.errorDescription( response.msg );
            }
            
            self.genClientCrtReady( true );
          }
        );      
      }
      
      if ( ! self.outClientCsr() ) {
        self.genClientCsr( mycb );
      } else {
        mycb();
      }      
    }


    self.genP12 = function () {
      clearError();
      self.genP12Ready( false );
      
      var key = self.inPKCSClientKey(),
          crt = self.inPKCSClientCrt(),
          pwd = self.inPKCSClientPwd(),
          Xpw = self.inPKCSClientXpw();
      
      
      /*  FIXME  */
      
      $( '<form action=' + addr + suffix + ' method="POST"></form>' )
        .append( '<input type="hidden" name="action" value="genP12" />' )
        .append( '<input type="hidden" name="key" value="' + key + '"/>' )
        .append( '<input type="hidden" name="crt" value="' + crt + '"/>' )
        .append( '<input type="hidden" name="pwd" value="' + pwd + '"/>' )
        .append( '<input type="hidden" name="Xpw" value="' + Xpw + '"/>' )
        .appendTo( 'iframe' );
      
      $( 'iframe' ).find( 'form' ).submit();
      $( 'iframe' ).empty();

      self.genP12Ready( true );
    }
    
/*    
    self.convP12 = function () {
      self.outPKCSpem( null );
      clearError();
      self.convP12Ready( false );

      var form = document.forms.namedItem( "convP12form" ),
          fd = new FormData( form );

      fd.append( "action", "convP12" );

      plusRequest();
          
      $.ajax( {
        url: addr + suffix,
        type: "POST",
        data: fd,
        processData: false,
        contentType: false,
        dataType: "text",
        cache: false,
        success: function ( response ) {
          self.convP12Ready( true );
        },
        error: function ( xhr, type, error ) {
          self.errorMessage( error );
        },
        complete: function () {
          minusRequest();
        }
      } );
    
      return false;
    }    
*/    

    self.UpdateDBbtn = function () {
      if ( self.isUpdate() ) {
        /*  edit  */
        var index = self.DBList.indexOf( self.dbname() );
        console.log( index );
      } else {
        /*  create  */
        self.DBList.push( { name: self.dbname(),
                            desc: self.dbdesc(),
                            open: false } );        
      }
      
      self.tUpdateDB();
    }

    self.WipeDBbtn = function () {
      
    }
    
    self.openDB = function () {
      this.open = this.open ? false : true; 
    }
    
    self.editDB = function () {
      self.tUpdateDB();
      self.isUpdate( true );
      self.dbname( this.name );
      self.dbdesc( this.desc );
      self.dbopen( this.open );
    }
    
    self.removeDB = function () {
      self.DBList.remove( this );
    }


    /*  Helpers  */

    function cleanAll () {
      clearError();

      self.onAbout( false );
      self.onCA( false );
      self.onClient( false );
      self.onPKCS( false );
      self.onConfigure( false );      
    }

    function clearError () {
      self.errorMessage( null );
      self.errorDescription( null );
    }

    function plusRequest() {
      var n = self.onAJAX() ? self.onAJAX() : 0;
      self.onAJAX( n + 1 );
    }

    function minusRequest() {
      var n = self.onAJAX() ? self.onAJAX() : 1;
      self.onAJAX( n - 1 );
    }

    function getJSON ( url, cb ) {
      plusRequest();

      $.ajax( {
        type: 'GET',
        url: url,
        dataType: 'json',
        cache: false,
        success: cb,
        error: function ( xhr, type, error ) {
          self.errorMessage( error );
        },
        complete: function () {
          minusRequest();
        }
      } );
    }

    function postJSON ( url, payload, cb ) {
      plusRequest();

      $.ajax( {
        type: 'POST',
        url: url,
        data: payload,
        dataType: 'json',
        success: cb,
        error: function ( xhr, type, error ) {
          self.errorMessage( error );
        },
        complete: function () {
          minusRequest();
        }
      } );
    }
    
    function getRequest ( action, name, cb ) {
      getJSON( ra + 'action=' + action + '&name=' + name, function( data ) {
        if ( data.err == null ) {
          cb( data );
        } else {
          self.errorMessage( errors[ data.err ] );
        }
      } );
    }

    /*  Router functions  */

    function mainPage () {
      cleanAll();
      self.onAbout( true );
    }

    function caPage () {
      cleanAll();
      self.onCA( true );      
      self.inCAPassword() ? "" : self.inCAPassword( 'test' );
      self.inCADays() ? "" : self.inCADays( 365 );
      self.inCASubject()
        ? "" 
        : self.inCASubject( '/CN=' + window.location.host + '/O=plcrtd' );
      self.genCAkeyReady( true );
      self.genCAcrtReady( true );
    }

    function clientPage () {
      cleanAll();
      self.onClient( true );
      self.genClientKeyReady( true );
      self.genClientCrtReady( true );
      self.genClientCsrReady( true );
      self.inClientPassword() ? "" : self.inClientPassword( 'test' );
      self.inClientDays() ? "" : self.inClientDays( 365 );
      self.inClientSubject()
        ? ""
        : self.inClientSubject( '/CN=' + window.location.host );
      self.inClientSerial() ? "" : self.inClientSerial( '01' );
      self.inClientCAPassword() ? "" : self.inClientCAPassword( 'test' );
    }

    function pkcsPage () {
      cleanAll();
      self.onPKCS( true );
      self.genP12Ready( true );
      self.inPKCSClientPwd() ? "" : self.inPKCSClientPwd( 'test' );
      self.convP12Ready( true );
    }
    
    function configurePage () {
      cleanAll();
      self.onConfigure( true );
    }
    

    /*  Setup routers  */

    crossroads.addRoute( '', mainPage );
    crossroads.addRoute( '/', mainPage );
    var actionsRouter = crossroads.addRoute( '{action}' );

    actionsRouter.matched.add( function ( action ) {
      switch ( action ) {
        case 'ca':
          caPage();
          break;
        case 'client':
          clientPage();
          break;
        case 'pkcs':
          pkcsPage();
          break;
        case 'configure':
          configurePage();
          break;
        default:
          mainPage();
      }
    } );

    /*  Setup hasher  */

    function parseHash ( newHash, oldHash ) {
      /* location has been switched to '/' */
      if ( newHash == undefined || newHash === "" ) {
        cleanAll();
        mainPage();
      }

      crossroads.parse( newHash );
    }

    hasher.initialized.add( parseHash ); /* parse initial hash */
    hasher.changed.add( parseHash );     /* parse hash changes */
    hasher.init();                       /* start listening for history change */
  }

  ko.applyBindings( new AppViewModel() );
</script>
</body>
</html>
