<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The plcrtd project: OpenSSL Certificate Manager">
  <meta name="keywords" content="perl, knockout, openssl, ca, pkcs, generator, online">
  <meta name="author" content="gh0stwizard">
  <meta charset="utf-8">
  <title>plcrtd &part; OpenSSL Certificate Manager &forall;</title>
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <script type="text/javascript" src="/js/knockout-3.3.0.js"></script>
  <script type="text/javascript" src="/js/zepto.min.js"></script>
  <script type="text/javascript" src="/js/signals.min.js"></script>
  <script type="text/javascript" src="/js/crossroads.min.js"></script>
  <script type="text/javascript" src="/js/hasher.min.js"></script>
<style type="text/css">
  html, body, button, p, input, select {
    font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
    font-size: 1.0em;
  }
  
  textarea {
    font-family: "Lucida Console", Monaco, monospace;
    font-size: 1.0em;
    border: 0;
  }

  /*  http://css3buttongenerator.com  */

  .btn {
    color: #ffffff;
    font-size: 0.85em;
    background: #16167a;
    padding: 7px 20px 7px 20px;
    text-decoration: none;
    border: 0;
  }
  .btn:hover {
    background: #339955;
  }
  
  /* http://stackoverflow.com/questions/3759692/css-selector-for-disabled-input-type-submit */
  
  input[type=submit]:disabled.btn,
  button:disabled.btn {
    background: #993355;
  }

  /*  Error message  */

  .errorBox p {
    text-align: center;
    font-size: 1.4em;
    font-weight: bolder;
  }

  .content {
    left: 0;
    right: 0;
    width: 90%;
    margin: 0 auto;
    max-width: 1024px;
  }

  /*  Header  */

  .header button {
    margin-left: 18px;
  }
  .header img {
    height: 24px;
    width: 24px;
    float: right;
    vertical-align: middle;
  }

  /*  Pages  */

  .aboutPage,
  .caPage {
    padding-top: 22px;
  }

  /*  About  */

  .aboutPage {
    padding-left: 10px;
  }
  
  /* Text data container */
  
  .boxContainer {
    display: flex;
  }
  
  .boxOutput {
    border: 1px solid black;
  }
  
  .boxButtonsContainer {
    display: inline;
    padding-top: 16px;
    padding-left: 12px;
  }  
  .boxButtonsContainer button {
    margin: 12px 0;
    width: 120px;
  }
  
  .boxSetup {
    padding-top: 5px;
    padding-bottom: 15px;
  }  
  .boxSetup p {
    display: inline;
    padding-right: 12px;
    color: #039;
  }
  .boxSetup select {
    border: 1px solid #029;
  }
  .boxSetup input {
    border: 0;
    border-bottom: 1px solid #029;
  }
  
  /*  Footer  */
  
  .footer {
    padding-top: 15px;
    padding-bottom: 15px;
  }

</style>
</head>
<body>
<div class="content">

  <!-- Header :: buttons & loading animation //-->
  <div class="header">
      <button class="btn" data-bind="click: About">About</button>
      <button class="btn" data-bind="click: CA">CA</button>
      <button class="btn" data-bind="click: Client">Client</button>
      <button class="btn" data-bind="click: PKCS">PKCS</button>
      <!-- http://spiffygif.com //-->
      <img src="/img/spiffygif.gif" alt="Loading"
           data-bind="visible: onAJAX()" />
  </div>

  <!-- Error message box //-->
  <div class="errorBox" data-bind="visible: errorMessage()">
    <p><span data-bind="text: errorMessage"></span></p>
    <pre><span data-bind="text: errorDescription"></span></pre>
  </div>
  

  <!-- About page //-->
  <div class="aboutPage" data-bind="visible: onAbout()">
    <h1>The plcrtd project: OpenSSL Certificate Manager</h1>
    <h2>Description</h2>
    <p>This is an online web certificate manager implemented
       as described in 
       <a title="Mini tutorial for configuring client-side SSL certificates."
          href="https://gist.github.com/mtigas/952344" >howto</a>
          written by 
       <a href="https://gist.github.com/mtigas"
          title="About user mtigas on GitHub">mtigas</a>.
    </p>
    <h2>Promises</h2>
    <p>The service was created by a sysadmin for the sysadmins.
       That's means, no information will be stored on a server side.
       Any piece of data you entered will be sent to the server 
       and computed via the 
       <a href="http://www.openssl.org/" title="OpenSSL homepage">openssl</a>
       command, and the results will be returned back to you 
       (a browser client) as soon as possible.</p>
    <p>Every piece of information you received from the server 
       you have to save on your computer immediately. 
       Otherwise, no one helps you to restore a data.</p>
    <h2>Development</h2>
    <p>This is an open source project. Please, checkout sources
      <a href="https://github.com/gh0stwizard/plcrtd"
         title="plcrtd on GitHub">here</a>.</p>
  </div>
  
  <!-- Certificate Authority Page //-->
  <div class="caPage" data-bind="visible: onCA()">
    <h3>Certificate Authority key</h3>
    <div class="boxSetup">
      <p>Password
      <input size="32" data-bind="value: inPassword" /></p>
      <p>Bits
      <select data-bind="options: [ 2048, 4096 ], value: inBits"></select></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outCAkey"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn"
                data-bind="click: genCAkey, enable: genCAkeyReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'ca.key', $root.outCAkey() ),
                     visible: outCAkey() && browserCheck(),
                     clickBubble: false">Save</button>
      </div>
    </div>
    <h3>Certificate Authority certificate</h3>
    <p>Please, provide the same password above as you've used for key generation.</p>
    <div class="boxSetup">
      <p>Subject
      <input size="42" class="subj" data-bind="value: inSubject" /></p>
      <p>Days
      <input size="4" data-bind="value: inDays" /></p>
    </div>
    <div class="boxContainer">
      <div class="boxOutput">
        <textarea rows="10" cols="66" data-bind="value: outCAcrt"></textarea>
      </div>
      <div class="boxButtonsContainer">
        <button class="btn" data-bind="click: genCAcrt, enable: genCAcrtReady()">Get!</button>
        <br />
        <button class="btn"
          data-bind="click: save.bind( $data, 'ca.crt', $root.outCAcrt() ),
                     visible: outCAcrt() && browserCheck()">Save</button>
      </div>
    </div>
  </div>

  <!-- Client Page //-->
  <div class="clientPage" data-bind="visible: onClient()">
    <h1>Client - not implemented yet</h1>
  </div>

  <!-- PKCS Page //-->
  <div class="pkcsPage" data-bind="visible: onPKCS()">
    <h1>PKCS - not implemented yet</h1>
  </div>
  
  <div class="footer"></div>

</div>
<script>
  var suffix = '/plcrtd',
      addr = window.location.protocol + '//' + window.location.host
      ra = addr + suffix + '?',
      errors = [
        'Connection error',
        'Bad request',
        'Not implemented',
        'Internal error'
      ];

  /* http://stackoverflow.com/questions/5999998/how-can-i-check-if-a-javascript-variable-is-function-type */

  function isFunction ( functionToCheck ) {
    var getType = {};
    return functionToCheck 
        && getType.toString.call(functionToCheck) === '[object Function]';
  }
  

  function AppViewModel() {
    var self = this;
    
    /*  Data  */

    self.onAJAX = ko.observable();
    self.errorMessage = ko.observable();
    self.errorDescription = ko.observable();

    /*  Data: this app  */

    self.onAbout = ko.observable();
    self.onCA = ko.observable();
    self.onClient = ko.observable();
    self.onPKCS = ko.observable();

    self.inPassword = ko.observable();
    self.inBits = ko.observable();
    self.inDays = ko.observable();
    self.inSubject = ko.observable();

    self.outCAkey = ko.observable();
    self.genCAkeyReady = ko.observable();

    self.outCAcrt = ko.observable();
    self.genCAcrtReady = ko.observable();

    self.browserCheck = ko.computed( function () {
      var version = parseFloat( navigator.appVersion );

      /* TODO mobile support ? */

      return ( navigator.userAgent.indexOf( "Firefox" ) != -1 
            && version > 20 )
          || ( navigator.userAgent.indexOf( "SeaMonkey" ) != -1 
            && version > 2.0 )
          || ( navigator.userAgent.indexOf( "Chrome" ) != -1
            && version > 14 )
          || ( navigator.userAgent.indexOf( "Firefox" ) != -1
            && version > 15 );
    } );
    

    /*  Behaviours  */

    self.About  = function () { location.hash = '';       }
    self.CA     = function () { location.hash = 'ca';     }
    self.Client = function () { location.hash = 'client'; }
    self.PKCS   = function () { location.hash = 'pkcs';   }

    /*  http://caniuse.com/download  */

    self.save = function ( filename, text ) {
      var pom = document.createElement( 'a' );
      pom.setAttribute( 'href',
        'data:text/plain;charset=utf-8,' + encodeURIComponent(text) );
      pom.setAttribute( 'download', filename );

      if ( document.createEvent ) {
        var event = document.createEvent( 'MouseEvents' );
        event.initEvent( 'click', true, true );
        pom.dispatchEvent( event );
      } else {
        pom.click();
      }
    }

    self.genCAkey = function ( cb ) {
      self.outCAkey( null );
      self.outCAcrt( null );
      clearError();
      
      self.genCAkeyReady( false );

      var pass = self.inPassword(),
          bits = self.inBits();
      
      postJSON( addr + suffix,
        { 
          action: 'genCAkey',
          pass: pass,
          bits: bits
        },
        function ( response ) {
          if ( response.key ) {
            self.outCAkey( response.key );
            isFunction( cb ) ? cb() : "";
          } else {
            self.errorMessage( errors[ response.err ] );
            self.errorDescription( response.msg );
          }
          
          self.genCAkeyReady( true );
        }
      );
    }
    
    self.genCAcrt = function () {
      self.outCAcrt( null );
      clearError();
      
      self.genCAcrtReady( false );
    
      var cb = function () {
        var pass = self.inPassword(),
            days = self.inDays(),
            subj = self.inSubject(),
            key = self.outCAkey();

        postJSON( addr + suffix,
          {
            action: 'genCAcrt',
            pass: pass,
            key: key,
            days: days,
            subj: subj
          },
          function ( response ) {
            if ( response.crt ) {
              self.outCAcrt( response.crt );
            } else {
              self.errorMessage( errors[ response.err ] );
              self.errorDescription( response.msg );
            }
            
            self.genCAcrtReady( true );
          }
        );
      }

      if ( ! self.outCAkey() ) {
        self.genCAkey( cb );
      } else {
        cb();
      }
    }

    /*  Formaters  */

    /*  Helpers  */
    
    function cleanAll () {
      clearError();
    
      self.onAbout( false );
      self.onCA( false );
      self.onClient( false );
      self.onPKCS( false );
    }
    
    function clearError () {
      self.errorMessage( null );
      self.errorDescription( null );
    }
    
    function plusRequest() {
      var n = self.onAJAX() ? self.onAJAX() : 0;
      self.onAJAX( n + 1 );
    }
    
    function minusRequest() {
      var n = self.onAJAX() ? self.onAJAX() : 1;
      self.onAJAX( n - 1 );
    }

    function getJSON ( url, cb ) {
      plusRequest();

      $.ajax( {
        type: 'GET',
        url: url,
        dataType: 'json',
        cache: false,
        success: cb,
        error: function ( xhr, type, error ) {
          self.errorMessage( error );
        },
        complete: function () {
          minusRequest();
        }
      } );
    }

    function postJSON ( url, payload, cb ) {
      plusRequest();

      $.ajax( {
        type: 'POST',
        url: url,
        data: payload,
        dataType: 'json',
        success: cb,
        error: function ( xhr, type, error ) {
          self.errorMessage( error );
        },
        complete: function () {
          minusRequest();
        }
      } );
    }

    function getRequest ( action, name, cb ) {
      getJSON( ra + 'action=' + action + '&name=' + name, function( data ) {
        if ( data.err == null ) {
          cb( data );
        } else {
          self.errorMessage( errors[ data.err ] );
        }
      } );
    }

    /*  Router functions  */

    function mainPage () {
      cleanAll();
      self.onAbout( true );
    }
    
    function caPage () {
      cleanAll();
      self.onCA( true );      
      self.inPassword() ? "" : self.inPassword( 'test' );
      self.inDays() ? "" : self.inDays( 365 );
      self.inSubject()
        ? "" 
        : self.inSubject( '/C=US/ST=Texas/O=gh0stwizard/CN=plcrtd' );
      self.genCAkeyReady( true );
      self.genCAcrtReady( true );
    }
    
    function clientPage () {
      cleanAll();
      self.onClient( true );
    }

    function pkcsPage () {
      cleanAll();
      self.onPKCS( true );
    }

    /*  Setup routers  */

    crossroads.addRoute( '', mainPage );
    crossroads.addRoute( '/', mainPage );
    var actionsRouter = crossroads.addRoute( '{action}' );

    actionsRouter.matched.add( function ( action ) {
      switch ( action ) {
        case 'ca':
          caPage();
          break;
        case 'client':
          clientPage();
          break;
        case 'pkcs':
          pkcsPage();
          break;
        default:
          mainPage();
      }
    } );

    /*  Setup hasher  */

    function parseHash ( newHash, oldHash ) {
      /* location has been switched to '/' */
      if ( newHash == undefined || newHash === "" ) {
        cleanAll();
        mainPage();
      }

      crossroads.parse( newHash );
    }

    hasher.initialized.add( parseHash ); /* parse initial hash */
    hasher.changed.add( parseHash );     /* parse hash changes */
    hasher.init();                       /* start listening for history change */
  }

  ko.applyBindings( new AppViewModel() );
</script>
</body>
</html>
